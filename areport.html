<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Báo cáo tự động (Auto Report)</title>
  
  <link rel="stylesheet" href="style.css">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- GIỮ NGUYÊN CSS GỐC CỦA BẠN --- */
    body { background-color: #f8fafc; font-family: 'Segoe UI', system-ui, sans-serif; }
    
    .smart-card {
      background: white; border-radius: 0 0 12px 12px; /* Bo góc dưới */
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0; margin-bottom: 24px; overflow: hidden;
    }

    /* HEADER TÙY BIẾN LẠI */
    .qr-header-flat {
      padding: 12px 20px; 
      background-color: #fff;
      border-bottom: 1px solid #f1f5f9; 
      display: flex; justify-content: space-between; align-items: center; 
      gap: 20px; flex-wrap: wrap; 
    }
    
    .qr-title-flat {
      font-size: 1.2rem; color: #1e293b; font-weight: 700; 
      display: flex; align-items: center; gap: 10px;
      white-space: nowrap; 
    }

    /* NÚT LỆNH TRÊN HEADER */
    .header-action-btn {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
        color: white; border: none;
        padding: 10px 24px; border-radius: 8px; font-weight: 600; 
        box-shadow: 0 4px 6px rgba(37,99,235,0.2);
        transition: all 0.2s;
        width: auto; white-space: nowrap;
        display: flex; align-items: center; gap: 8px;
    }
    .header-action-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(37,99,235,0.3); }
    .header-action-btn:disabled { 
        background: #f1f5f9; color: #94a3b8; border: 1px solid #e2e8f0;
        box-shadow: none; cursor: not-allowed; transform: none; font-weight: 500;
    }

    /* GRID STYLES */
    .qr-grid-wrapper { border: none; }
    .qr-col-header { min-width: 170px !important; white-space: nowrap !important; flex-shrink: 0 !important; font-weight: 600; color: #475569; }
    .qr-cell {
      cursor: pointer; transition: background 0.2s; 
      width: 35px !important; min-width: 35px !important; max-width: 35px !important; flex: 0 0 35px !important;  
    }
    .qr-cell:hover { background-color: #f1f5f9; }

    /* --- EDITOR PANEL --- */
    #editorPanel {
      display: none; border-top: 4px solid #3b82f6; border-radius: 8px; margin-top: 10px;
      animation: slideDown 0.4s ease-out; background: white; 
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .editor-header {
      background: #eff6ff; padding: 6px 6px; border-bottom: 1px solid #dbeafe;
      display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0;
    }
    
    .table-preview-container { 
        overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 8px; background: white; 
    }
    .table thead th { height: 39px !important; background-color: #f1f5f9; color: #475569; font-weight: 600; vertical-align: middle; }
    .req-field { border-left: 3px solid #ef4444 !important; }
    .text-center-input { text-align: center; }
    .highlight-update { animation: flash-update 0.8s; }
    @keyframes flash-update { 0% { background-color: #dcfce7; } 100% { background-color: transparent; } }
    .row-conflict { background-color: #fef2f2 !important; }

    /* --- TÙY CHỈNH KÍCH THƯỚC BẢNG --- */
    .table-preview-container .table td, 
    .table-preview-container .table th {
        padding: 0px !important; vertical-align: middle !important; 
        border: none !important; max-height: 35px !important;
    }
    .table-preview-container .form-control-sm,
    .table-preview-container .form-select-sm {
        height: 35px !important; font-size: 14px !important; 
    }
    .table-preview-container .note-input { min-width: 150px; }
  </style>
</head>
<body>

  <header>
    <button class="btn btn-outline-light btn-sm me-3" onclick="goHome()" title="Trang chủ"><i class="bi bi-house"></i></button>
    <h5 class="m-0 fw-bold">BÁO CÁO TIẾN ĐỘ THỰC HIỆN CHƯƠNG TRÌNH</h5>
    <div class="user-area">
      <div class="user-info">
        <div class="fullname" id="uName">Đang tải...</div>
        <div class="role" id="uRole">...</div>
      </div>
      <div class="avatar-circle" id="uAvatar">?</div>
    </div>
  </header>

  <div style="padding: 15px; width: 100%; margin: 0;">
      
     <div class="smart-card" id="selectionCard">
        <div class="qr-header-flat">
           <div class="qr-title-flat">
              <i class="fas fa-calendar-alt text-primary"></i> 
              NĂM HỌC<span id="lblCurrentYear" class="ms-1">...</span>
           </div>
           
           <div>
               <button class="header-action-btn" id="btnExecuteQR" disabled onclick="renderEditorPanel()">
                  <i class="fas fa-magic"></i>
                  <span id="btnTxt">Vui lòng chọn tuần cần báo cáo</span>
                  <span id="btnLoad" class="spinner-border spinner-border-sm d-none"></span>
               </button>
           </div>
        </div>

        <div class="qr-body" style="padding: 0;">
           <div id="qrGridContainer" class="qr-grid-wrapper">
               <div class="qr-loading">Đang tải dữ liệu...</div>
           </div>
        </div>
     </div>

     <div id="editorPanel">
        <div class="editor-header">
            <h6 class="mb-0 fw-bold text-primary"><i class="fas fa-edit me-2"></i>CHI TIẾT DỰ THẢO BÁO CÁO</h6>
            <div>
                <button class="btn btn-sm btn-outline-danger me-2" onclick="closeEditor()"><i class="fas fa-times me-1"></i>Đóng</button>
                <button class="btn btn-sm btn-success fw-bold px-4 shadow-sm" id="btnSave" onclick="submitNewReports()">
                    <i class="fas fa-save me-1"></i> LƯU SỔ BÁO GIẢNG
                </button>
            </div>
        </div>
        
        <div class="p-4">
            <div id="conflictAlert" class="alert alert-danger d-none py-2 px-3 mb-3 small shadow-sm border-danger">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> <strong>Cảnh báo:</strong> Phát hiện trùng lặp tiết dạy. Vui lòng kiểm tra các dòng được tô đỏ.
            </div>

            <div class="table-preview-container">
                <table class="table table-bordered table-sm mb-0 align-middle table-hover" style="min-width: 1500px;">
                  <thead class="sticky-top">
                    <tr>
                      <th style="width:50px" class="text-center">#</th>
                      <th style="width:100px">Ngày dạy*</th>
                      <th style="width:70px">Lớp*</th>
                      <th style="width:90px">Buổi*</th>
                      <th style="width:70px" class="text-center">Tiết*</th>
                      <th style="width:180px">Môn học*</th>
                      <th style="width:50px" class="text-center">PPCT*</th>
                      <th style="width:50px" class="text-center">Bài số</th>
                      <th style="min-width:300px">Tên bài học</th>
                      <th style="width:200px">Giáo viên*</th>
                      <th style="width:150px">Địa điểm</th>
                      <th>Ghi chú</th>
                    </tr>
                  </thead>
                  <tbody id="formBody"></tbody>
                </table>
            </div>
            <div class="mt-3">
                <button class="btn btn-sm btn-outline-primary border-dashed" onclick="addNewFormRow()">
                    <i class="fas fa-plus-circle me-1"></i> Thêm tiết dạy thủ công
                </button>
            </div>
        </div>
     </div>

  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="script.js"></script>

  <script>
    
    let SUGGESTIONS = {}, CURRENT_SCHOOL_YEAR = "";
    let lastValues = { classId: "", subjectId: "" };
    // Lấy thông tin user từ LocalStorage
    const user = JSON.parse(localStorage.getItem('userData')) || { Name: "Khách", "User ID": "Guest", Permissions: "Giáo viên" };

    // --- INIT ---
    window.onload = async function() {
       if (user) {
         document.getElementById('uName').textContent = user.Name;
         document.getElementById('uRole').textContent = user.Permissions || "Giáo viên";
         document.getElementById('uAvatar').textContent = (user.Name || "?").charAt(0);
       }
       
       loadQRData();
       
       // Lấy dữ liệu gợi ý (Data Init)
       const res = await callBackend('getData', { userObj: user });
       if(res && res.success) SUGGESTIONS = res.suggestions;
    };

    function goHome() { window.location.href = "wellcome.html"; }

    // --- LOAD GRID ---
    async function loadQRData() {
      const container = document.getElementById("qrGridContainer");
      container.innerHTML = '<div class="qr-loading"><span><i class="fas fa-circle-notch fa-spin"></i> Đang tải dữ liệu...</span></div>';
      
      // Lấy Account từ user object để gửi lên server
      const userEmailToSend = user['Account'] || user['User ID'] || "";
      
      // GỌI API
      const data = await callBackend('getQuickReportConfig', { userEmail: userEmailToSend });
      
      renderQRInterface(data);
    }

    function renderQRInterface(data) {
      if (!data.success) {
        document.getElementById("qrGridContainer").innerHTML = `<div style="color:red; padding:20px;">Lỗi: ${data.error}</div>`;
        return;
      }
      
      CURRENT_SCHOOL_YEAR = data.currentYear;
      document.getElementById("lblCurrentYear").innerText = data.currentYear; 

      let htmlSchoolWeek = '', htmlPlanWeek = '', htmlTKB = '', htmlReport = ''; 
      data.weeks.forEach(week => {
        const titleInfo = `Tuần ${week.schoolWeek}: ${week.startStr} - ${week.endStr}`;
        htmlSchoolWeek += `<div class="qr-cell" title="${titleInfo}">${week.schoolWeek}</div>`;
        htmlPlanWeek   += `<div class="qr-cell" title="${titleInfo}">${week.planWeek}</div>`;
        
        htmlTKB += week.hasTKB ? `<div class="qr-cell"><i class="fas fa-check-circle text-success"></i></div>` : `<div class="qr-cell"></div>`;

        // Logic hiển thị dấu Check đã báo cáo
        if (week.isReported) {
          htmlReport += `<div class="qr-cell"><i class="fas fa-check-circle text-primary"></i></div>`;
        } else if (week.hasTKB) {
          let rawStart = week.start;
          let rawEnd = week.end;
          // Fallback logic
          if (!rawStart && week.startStr) rawStart = parseDateStr(week.startStr);
          if (!rawEnd && week.endStr) rawEnd = parseDateStr(week.endStr);

          htmlReport += `<div class="qr-cell">
                           <input type="checkbox" class="chk-week" value="${week.id}" 
                                  data-start="${rawStart}" data-end="${rawEnd}"
                                  data-display-start="${week.startStr}" data-display-end="${week.endStr}"
                                  onchange="checkBtnState()">
                         </div>`;
        } else {
          htmlReport += `<div class="qr-cell bg-light"></div>`;
        }
      });

      document.getElementById("qrGridContainer").innerHTML = `
        <div class="qr-row row-nh"><div class="qr-col-header">Tuần năm học</div>${htmlSchoolWeek}</div>
        <div class="qr-row row-cm"><div class="qr-col-header">Tuần chuyên môn</div>${htmlPlanWeek}</div>
        <div class="qr-row row-tkb" style="background:#fffcfc;"><div class="qr-col-header">Thời khóa biểu</div>${htmlTKB}</div>
        <div class="qr-row row-bg" style="background:#f8fafc;">
          <div class="qr-col-header">
             <div style="display:flex; align-items:center; gap:8px;">
               <span>Báo cáo chương trình</span>
             </div>
          </div>${htmlReport}
        </div>`;
        
      checkBtnState(); 
    }

    function parseDateStr(str) {
        if (!str) return "";
        const parts = str.split('/');
        let y = new Date().getFullYear(); 
        if (parts.length === 3) y = parts[2];
        return `${y}-${parts[1]}-${parts[0]}`; 
    }

    // --- XỬ LÝ NÚT LỆNH ---
    function checkBtnState() {
      const cbs = document.querySelectorAll('.chk-week:checked');
      const btn = document.getElementById("btnExecuteQR");
      const txt = document.getElementById("btnTxt");
      
      if (cbs.length > 0) {
        btn.disabled = false;
        const s = cbs[0].getAttribute('data-display-start');
        const e = cbs[cbs.length - 1].getAttribute('data-display-end');
        txt.innerHTML = `Lập dự thảo báo cáo từ ${s} đến hết ngày ${e}`;
      } else {
        btn.disabled = true;
        txt.innerHTML = `Vui lòng chọn tuần cần báo cáo`;
        closeEditor();
      }
    }

    // --- EDITOR PANEL ---
    async function renderEditorPanel() {
       const checkboxes = document.querySelectorAll('.chk-week:checked');
       if (checkboxes.length === 0) return;

       const startDateStr = checkboxes[0].getAttribute('data-start');
       const endDateStr = checkboxes[checkboxes.length - 1].getAttribute('data-end');

       toggleBtnLoading(true);

       // --- FIX BUG CHỈ CÓ 1 DÒNG: MAPPING USER ĐỂ KHỚP VỚI SERVER ---
       const userForServer = { ...user };
       // Server Code.gs (getMultiWeekTKBPreview) tìm "Reminiscent Name" (có dấu cách)
       // Nhưng localStorage hiện tại lưu "ReminiscentName" (không dấu cách)
       if (userForServer.ReminiscentName && !userForServer["Reminiscent Name"]) {
           userForServer["Reminiscent Name"] = userForServer.ReminiscentName;
       }
       if (userForServer.UserID && !userForServer["User ID"]) {
           userForServer["User ID"] = userForServer.UserID;
       }

       // Gọi API lấy dữ liệu xem trước từ TKB
       const rows = await callBackend('getTKBPreviewData', { from: startDateStr, to: endDateStr, userObj: userForServer });
       
       toggleBtnLoading(false);
       document.getElementById('formBody').innerHTML = '';
       
       if (rows && Array.isArray(rows) && rows.length > 0) {
           const startTs = new Date(startDateStr).setHours(0,0,0,0);
           const endTs = new Date(endDateStr).setHours(23,59,59,999);

           const filteredRows = rows.filter(r => {
               let rTs = 0;
               if (r.date.includes('/')) {
                   const parts = r.date.split('/');
                   rTs = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`).getTime();
               } else {
                   rTs = new Date(r.date).getTime();
               }
               return rTs >= startTs && rTs <= endTs;
           });

           if (filteredRows.length > 0) {
               // --- FIX BUG: DÙNG VÒNG LẶP AWAIT ĐỂ ĐẢM BẢO RENDER ĐỦ DÒNG ---
               for (const r of filteredRows) {
                   await addNewFormRow(r);
               }
           } else {
               await addNewFormRow(); 
           }
       } else {
           await addNewFormRow(); 
       }

       reCalcAllProgNums();
       const panel = document.getElementById('editorPanel');
       panel.style.display = 'block';
       panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function closeEditor() {
        document.getElementById('editorPanel').style.display = 'none';
        document.getElementById('selectionCard').scrollIntoView({ behavior: 'smooth' });
    }

    function toggleBtnLoading(isLoading) {
       const txt = document.getElementById('btnTxt');
       const spin = document.getElementById('btnLoad');
       const btn = document.getElementById('btnExecuteQR');
       if (isLoading) {
          txt.classList.add('d-none'); spin.classList.remove('d-none'); btn.disabled = true;
       } else {
          txt.classList.remove('d-none'); spin.classList.add('d-none'); btn.disabled = false;
       }
    }

    // --- FORM LOGIC (BẢO TOÀN) ---
    // Chuyển thành Async để dùng Await trong vòng lặp render
    async function addNewFormRow(init = null) {
      const tr = document.createElement('tr');
      let sessionOpts = `<option>Sáng</option><option>Chiều</option>`;
      let snOpts = Array.from({length:10},(_,i)=>`<option>${i+1}</option>`).join('');
      let subOpts = `<option value="">- Chọn môn -</option>`;
      if(SUGGESTIONS.subjects) Object.entries(SUGGESTIONS.subjects).forEach(([k,v])=> subOpts += `<option value="${k}">${v}</option>`);
      let teacherOpts = `<option value="">- GV -</option>`;
      if(SUGGESTIONS.teachers) Object.entries(SUGGESTIONS.teachers).forEach(([k,v])=> teacherOpts += `<option value="${k}">${v}</option>`);
      let locOpts = `<option value="">- Phòng/Địa điểm -</option>`;
      if(SUGGESTIONS.locations) Object.entries(SUGGESTIONS.locations).forEach(([k,v])=> locOpts += `<option value="${k}">${v}</option>`);

      tr.innerHTML = `
        <td class="text-center">
          <div class="status-icon d-inline-block"><i class="bi bi-dash-circle text-secondary"></i></div>
          <i class="bi bi-trash text-danger ms-2" style="cursor:pointer" onclick="this.closest('tr').remove(); reCalcAllProgNums(); validateForm()"></i>
        </td>
        <td><input type="text" class="form-control form-control-sm req-field date-input"></td>
        <td><select class="form-select form-select-sm req-field class-sel"></select></td>
        <td><select class="form-select form-select-sm req-field session-sel">${sessionOpts}</select></td>
        <td><select class="form-select form-select-sm req-field sn-sel text-center-input">${snOpts}</select></td>
        <td><select class="form-select form-select-sm req-field sub-sel">${subOpts}</select></td>
        <td><input type="number" class="form-control form-control-sm req-field prog-input text-center-input"></td>
        <td><input type="text" class="form-control form-control-sm l-num bg-light text-center-input text-muted" readonly></td>
        <td><input type="text" class="form-control form-control-sm l-name bg-light text-muted" readonly></td>
        <td><select class="form-select form-select-sm req-field teacher-sel">${teacherOpts}</select></td>
        <td><select class="form-select form-select-sm loc-sel">${locOpts}</select></td>
        <td><input type="text" class="form-control form-control-sm note-input"></td>`;

      document.getElementById('formBody').appendChild(tr);

      const dInp = tr.querySelector('.date-input');
      flatpickr(dInp, {
        dateFormat: "Y-m-d", altInput: true, altFormat: "d/m/Y",
        onChange: (_, dateStr) => { dInp.value = dateStr; updateClassList(dInp); reCalcAllProgNums(); validateForm(); }
      });

      const cSel = tr.querySelector('.class-sel');
      const sSel = tr.querySelector('.sub-sel');
      const pInp = tr.querySelector('.prog-input');

      [cSel, sSel].forEach(el => el.addEventListener('focus', () => { lastValues.classId = cSel.value; lastValues.subjectId = sSel.value; }));
      cSel.addEventListener('change', () => { lookupLesson(cSel); reCalcSmart(tr, lastValues.classId, lastValues.subjectId); validateForm(); });
      sSel.addEventListener('change', () => { lookupLesson(sSel); reCalcSmart(tr, lastValues.classId, lastValues.subjectId); validateForm(); });
      pInp.addEventListener('change', () => { lookupLesson(pInp); reCalcFromManualInput(tr); validateForm(); });
      
      [tr.querySelector('.session-sel'), tr.querySelector('.sn-sel'), tr.querySelector('.teacher-sel')].forEach(el => el.addEventListener('change', validateForm));

      if (init) {
        dInp._flatpickr.setDate(init.date);
        updateClassList(dInp); 
        cSel.value = init.classId;
        tr.querySelector('.session-sel').value = init.session;
        tr.querySelector('.sn-sel').value = init.sessionNum;
        sSel.value = init.subjectId;
        pInp.value = init.progNum || "";
        tr.querySelector('.teacher-sel').value = init.teacherId;
        tr.querySelector('.loc-sel').value = init.locationId || "";
        tr.querySelector('.note-input').value = ""; 

      } else {
        dInp._flatpickr.setDate(new Date());
        updateClassList(dInp);
        if(SUGGESTIONS.teachers) {
            const myId = Object.keys(SUGGESTIONS.teachers).find(k => SUGGESTIONS.teachers[k] === user.Name);
            if(myId) tr.querySelector('.teacher-sel').value = myId;
        }
      }
    }

    function updateClassList(dEl) {
      const tr = dEl.closest('tr');
      const val = dEl.value; if(!val) return;
      const time = new Date(val).getTime();
      let year = CURRENT_SCHOOL_YEAR;
      if (SUGGESTIONS.schoolYears) {
         const found = SUGGESTIONS.schoolYears.find(y => time >= new Date(y.start).getTime() && time <= new Date(y.end).getTime());
         if(found) year = found.name;
      }
      tr.dataset.schoolYear = year;
      let h = '<option value="">- Lớp -</option>';
      if (SUGGESTIONS.classes) {
         Object.entries(SUGGESTIONS.classes).filter(([_,v]) => v.year === year).forEach(([id,v]) => h += `<option value="${id}">${v.name}</option>`);
      }
      tr.querySelector('.class-sel').innerHTML = h;
    }

    function validateForm() {
      const btn = document.getElementById('btnSave');
      const alertBox = document.getElementById('conflictAlert');
      const rows = Array.from(document.querySelectorAll('#formBody tr'));
      let hasEmpty = false, hasConflict = false;
      rows.forEach(r => r.classList.remove('row-conflict'));
      rows.forEach((tr1, idx1) => {
        let empty = false;
        tr1.querySelectorAll('.req-field').forEach(f => { if (!f.value.trim()) empty = true; });
        if (empty) hasEmpty = true;
        if (!empty) {
          const d1 = tr1.querySelector('.date-input').value, c1 = tr1.querySelector('.class-sel').value;
          const ss1 = tr1.querySelector('.session-sel').value, sn1 = tr1.querySelector('.sn-sel').value;
          const sb1 = tr1.querySelector('.sub-sel').value, pg1 = tr1.querySelector('.prog-input').value, t1 = tr1.querySelector('.teacher-sel').value;
          rows.forEach((tr2, idx2) => {
            if (idx1 === idx2) return;
            const d2 = tr2.querySelector('.date-input').value, c2 = tr2.querySelector('.class-sel').value;
            const ss2 = tr2.querySelector('.session-sel').value, sn2 = tr2.querySelector('.sn-sel').value;
            const sb2 = tr2.querySelector('.sub-sel').value, pg2 = tr2.querySelector('.prog-input').value, t2 = tr2.querySelector('.teacher-sel').value;
            
            if ((d1===d2 && c1===c2 && ss1===ss2 && sn1===sn2) || (c1===c2 && sb1===sb2 && pg1===pg2) || (d1===d2 && ss1===ss2 && sn1===sn2 && t1===t2 && c1!==c2)) { 
                tr1.classList.add('row-conflict'); hasConflict = true; 
            }
          });
        }
        tr1.querySelector('.status-icon').innerHTML = empty ? '<i class="bi bi-exclamation-circle-fill text-warning"></i>' : (tr1.classList.contains('row-conflict') ? '<i class="bi bi-x-circle-fill text-danger"></i>' : '<i class="bi bi-check-circle-fill text-success"></i>');
      });
      alertBox.classList.toggle('d-none', !hasConflict);
      btn.disabled = hasEmpty || hasConflict || rows.length === 0;
    }

    // --- LOGIC PPCT ---
    function reCalcFromManualInput(startTr) {
      const allRows = Array.from(document.querySelectorAll('#formBody tr'));
      const startIdx = allRows.indexOf(startTr);
      const startVal = parseInt(startTr.querySelector('.prog-input').value);
      const cId = startTr.querySelector('.class-sel').value, sId = startTr.querySelector('.sub-sel').value;
      if (isNaN(startVal) || !cId || !sId) return;
      let nextVal = startVal + 1;
      for (let i = startIdx + 1; i < allRows.length; i++) {
        const tr = allRows[i];
        if (tr.querySelector('.class-sel').value === cId && tr.querySelector('.sub-sel').value === sId) {
          tr.querySelector('.prog-input').value = nextVal;
          tr.querySelector('.prog-input').classList.add('highlight-update');
          setTimeout(() => tr.querySelector('.prog-input').classList.remove('highlight-update'), 800);
          lookupLesson(tr.querySelector('.prog-input')); nextVal++;
        }
      }
    }

    function reCalcSmart(currentTr, oldC, oldS) {
      const allRows = Array.from(document.querySelectorAll('#formBody tr'));
      const idx = allRows.indexOf(currentTr);
      const affectedC = new Set([oldC, currentTr.querySelector('.class-sel').value]);
      const affectedS = new Set([oldS, currentTr.querySelector('.sub-sel').value]);
      const rows = allRows.slice(idx).filter(tr => {
        const c = tr.querySelector('.class-sel').value, s = tr.querySelector('.sub-sel').value;
        return (affectedC.has(c) && c !== "") || (affectedS.has(s) && s !== "");
      });
      processRowGroups(rows, allRows);
    }

    function reCalcAllProgNums() {
      const allRows = Array.from(document.querySelectorAll('#formBody tr'));
      processRowGroups(allRows, allRows);
    }

    async function processRowGroups(rowsToProc, allRows) {
      const groups = {};
      rowsToProc.forEach(tr => {
        const c = tr.querySelector('.class-sel').value, s = tr.querySelector('.sub-sel').value;
        if (c && s) { const k = c + '_' + s; if (!groups[k]) groups[k] = []; groups[k].push(tr); }
      });
      
      // Chuyển đổi sang async/await vì cần gọi API
      for (const [key, group] of Object.entries(groups)) {
        const [cId, sId] = key.split('_');
        const firstMember = group[0];
        const idxAll = allRows.indexOf(firstMember);
        let maxA = 0;
        for (let i = 0; i < idxAll; i++) {
            const r = allRows[i];
            if (r.querySelector('.class-sel').value === cId && r.querySelector('.sub-sel').value === sId) {
                const v = parseInt(r.querySelector('.prog-input').value) || 0;
                if (v > maxA) maxA = v;
            }
        }
        
        // Gọi API lấy số tiếp theo
        const sheetNext = await callBackend('getNextProgramNumber', { cId, sId });
        let cur = Math.max(sheetNext || 1, maxA + 1);
        group.forEach(tr => { 
            tr.querySelector('.prog-input').value = cur; 
            lookupLesson(tr.querySelector('.prog-input')); 
            cur++; 
        });
        validateForm();
      }
    }

    async function lookupLesson(el) {
      const tr = el.closest('tr');
      const p = tr.querySelector('.prog-input').value.trim();
      const c = tr.querySelector('.class-sel').value, s = tr.querySelector('.sub-sel').value, y = tr.dataset.schoolYear;
      if (!p || !c || !s || !y) return;
      
      let block = SUGGESTIONS.classes && SUGGESTIONS.classes[c] ? SUGGESTIONS.classes[c].block : "";
      
      // Gọi API tra cứu
      const r = await callBackend('getLessonInfo', { schoolYear: y, subjectId: s, blockId: block, programNum: p });
      
      tr.querySelector('.l-num').value = r ? r.number : "";
      tr.querySelector('.l-name').value = r ? r.name : "Chưa có bài trong PPCT";
    }

    async function submitNewReports() {
      const btn = document.getElementById('btnSave');
      btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang lưu...';
      const rows = [...document.querySelectorAll('#formBody tr')].map(tr => ({
        date: tr.querySelector('.date-input').value.split('-').reverse().join('/'), 
        classId: tr.querySelector('.class-sel').value, 
        session: tr.querySelector('.session-sel').value, sessionNum: tr.querySelector('.sn-sel').value, 
        subjectId: tr.querySelector('.sub-sel').value, progNum: tr.querySelector('.prog-input').value, 
        teacherId: tr.querySelector('.teacher-sel').value, locationId: tr.querySelector('.loc-sel').value, 
        note: tr.querySelector('.note-input').value
      }));

      // Gọi API lưu
      const res = await callBackend('saveReportData', { rows, user });
      
      if (res && res.success) {
           Swal.fire("Thành công", `Đã lưu ${rows.length} tiết vào sổ`, "success").then(() => {
                closeEditor();
                loadQRData(); 
           });
      } else { 
           Swal.fire("Lỗi", res ? res.error : "Lỗi server", "error"); 
           btn.disabled = false; btn.innerHTML = '<i class="fas fa-save me-1"></i> LƯU SỔ BÁO GIẢNG'; 
      }
    }

  </script>
</body>
</html>
