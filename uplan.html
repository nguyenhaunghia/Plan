<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nhập Kế hoạch Giảng dạy</title>
  
  <link rel="stylesheet" href="style.css">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* ==========================================================================
       GIỮ NGUYÊN CSS GỐC CỦA BẠN (QUY TẮC BẢO TOÀN)
       ========================================================================== */
    :root {
      --primary-color: #4f46e5;
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #1f2937;
      --border-color: #e5e7eb;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      height: 100vh; overflow: hidden; margin: 0;
    }

    /* HEADER */
    header {
      position: sticky; top: 0; z-index: 1000;
      background: #0d47a1; /* MÀU TỪ FILE PLAN_TODAY */
      color: white;        
      padding: 6px 6px;
      border-bottom: 1px solid var(--border-color);
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    header .page-title {
      font-size: 1.3rem; font-weight: 700; 
      color: white; 
      margin: 0; display: flex; align-items: center; gap: 12px;
    }
    .btn-outline-secondary {
        color: white !important;
        border-color: rgba(255,255,255,0.5) !important;
    }
    .btn-outline-secondary:hover {
        background-color: rgba(255,255,255,0.2) !important;
        border-color: white !important;
    }
    .user-area { display: flex; align-items: center; gap: 12px; }
    .fullname { font-weight: 600; font-size: 0.95rem; color: white !important; }
    .role { font-size: 0.8rem; color: #cbd5e1 !important; } 
    .avatar-circle {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--primary-color); color: white;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 1.2rem;
    }

    /* TOOLBAR */
    .toolbar-container {
      background: var(--card-bg); padding: 8px 8px;
      border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin: 8px 8px; display: flex; align-items: center;
      justify-content: space-between; gap: 20px;
      border: 1px solid var(--border-color);
    }
    
    .badge-group { display: flex; align-items: center; gap: 12px; }
    .info-tag {
      display: flex; align-items: center; gap: 6px;
      padding: 6px 12px; border-radius: 8px;
      font-size: 0.85rem; font-weight: 600;
      background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e5e7eb;
    }

    /* TABLE STYLE */
    .table-wrapper {
      background: var(--card-bg); border-radius: 6px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
      height: calc(100vh - 240px); overflow: hidden;
      border: 1px solid var(--border-color);
      display: flex; flex-direction: column; margin: 0 8px 8px;
    }
    .table-responsive { flex-grow: 1; overflow: auto; }
    
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    
    /* Header Table */
    .table-resizable th {
      position: sticky; top: 0; z-index: 10;
      background-color: #f8fafc !important; 
      color: #4b5563;
      font-family: 'Inter', sans-serif;
      font-weight: 700; font-size: 0.8rem; text-transform: uppercase;
      padding: 14px 10px;
      border-bottom: 2px solid #e5e7eb !important;
      text-align: center !important; 
      white-space: nowrap; resize: horizontal; overflow: hidden;
    }

    /* Body Table */
    table td {
      padding: 12px 12px; 
      font-family: 'Inter', sans-serif !important; 
      font-size: 0.9rem !important;
      font-weight: 400 !important;
      font-style: normal !important;
      color: #334155;
      border-bottom: 1px solid #f3f4f6; 
      vertical-align: middle;
    }
    table tbody tr:hover td { background-color: #f8fafc; }

    /* Badge Trạng thái */
    .status-badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 10px; border-radius: 20px;
      font-size: 0.8rem; 
      font-weight: 400 !important;
    }
    .status-ok { background-color: #dcfce7; color: #166534; }
    .status-error { background-color: #fee2e2; color: #991b1b; }
    .row-error td { background-color: #fef2f2 !important; }
    
    .empty-state {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100%; color: #9ca3af; padding: 40px;
    }
    .empty-state i { font-size: 3rem; margin-bottom: 15px; opacity: 0.5; }
    
    .fade-in { animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Style cho form chọn năm học (Swal) */
    #swal2-html-container .form-group { margin-bottom: 1.5rem; }
    #swal2-html-container label { font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--text-main); }
    #swal2-html-container select { height: 48px; font-size: 1rem; }
  </style>
</head>
<body>

  <header>
    <div style="display: flex; align-items: center; gap: 16px;">
      <button class="btn btn-outline-secondary btn-sm" onclick="goHome()" title="Trang chủ">
        <i class="bi bi-house"></i>
      </button>
      <h5 class="page-title">
        <i class="bi bi-cloud-upload text-primary"></i>
        NHẬP KẾ HOẠCH GIẢNG DẠY
      </h5>
    </div>
    <div class="user-area">
      <div class="user-info text-end">
        <div class="fullname" id="uName">Loading...</div>
        <div class="role" id="uRole">...</div>
      </div>
      <div class="avatar-circle" id="uAvatar">?</div>
    </div>
  </header>

  <div class="container-fluid py-1 px-4">
    <div class="toolbar-container">
      <div class="d-flex align-items-center gap-3">
        <button class="btn btn-outline-primary btn-sm px-3 py-2" onclick="openSampleDialog()">
          <i class="bi bi-file-earmark-arrow-down me-2"></i>Tải file mẫu
        </button>
        <input type="file" id="excelFile" accept=".xlsx, .xls" style="display:none" onchange="processFile(this)">
        <button class="btn btn-outline-success btn-sm px-3 py-2" onclick="document.getElementById('excelFile').click()">
          <i class="bi bi-file-earmark-excel me-2"></i>Tải file Excel
        </button>
      </div>

      <div id="badgeArea" class="badge-group fade-in" style="display:none;"></div>

      <div id="actionArea" style="display: none;">
        <button id="btnSave" class="btn btn-primary btn-sm px-4 py-2 shadow-sm fw-bold" onclick="confirmAndSave()"></button>
      </div>
    </div>

    <div class="table-wrapper">
      <div class="table-responsive h-100">
        <table id="mainTable" class="table table-resizable mb-0">
          <thead>
            <tr>
              <th style="width: 130px;">Trạng thái</th>
              <th style="width: 150px;">Mã định danh</th>
              <th style="width: 100px;">Năm học</th>
              <th style="width: 120px;">Môn học</th>
              <th style="width: 60px;">Khối</th>
              <th style="width: 60px;">Tuần</th>
              <th style="width: 60px;">Tiết</th>
              <th style="width: 60px;">Bài</th>
              <th style="width: 350px;">Tên bài học</th>
              <th style="width: 150px;">Địa điểm</th>
              <th style="width: 200px;">Ghi chú</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="11" style="height: 400px; padding: 0; border: none;">
                <div class="empty-state">
                  <i class="bi bi-cloud-arrow-up"></i>
                  <p>Chưa có dữ liệu</p>
                  <small>Chọn "Tải file Excel" để bắt đầu</small>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="script.js"></script>

  <script>

    function goHome() {
      window.location.href = "wellcome.html";
    }


    // Load User
    window.addEventListener('load', function() {
      const user = JSON.parse(localStorage.getItem('userData')) || { Name: "Khách", Permissions: "" };
      document.getElementById('uName').textContent = user.Name;
      document.getElementById('uRole').textContent = user.Permissions;
      document.getElementById('uAvatar').textContent = (user.Name || "?").charAt(0).toUpperCase();
    });

    let RAW_SAVE_DATA = [], VALID_ROWS = [];

    // --- 1. TẠO FILE MẪU ---
    async function openSampleDialog() {
      showLoading('Đang tải danh sách...');

      // Gọi API lấy dữ liệu dropdown
      const data = await callBackend('getDropdownData', {});
      closeLoading();

      if (!data) return showToast('Lỗi tải dữ liệu!', 'error');

      const schoolOptions = data.schoolYears.map(y => `<option value="${y}">${y}</option>`).join('');
      const subjectOptions = data.subjects.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
      const blockOptions = data.blocks.map(k => `<option value="${k.id}">${k.name}</option>`).join('');

      const formHtml = `
        <div class="modern-form-group">
            <label class="modern-label">Năm học</label>
            <select id="f-namhoc" class="modern-select"><option value="">-- Chọn năm học --</option>${schoolOptions}</select>
        </div>
        <div class="modern-form-group">
            <label class="modern-label">Môn học</label>
            <select id="f-mon" class="modern-select"><option value="">-- Chọn môn học --</option>${subjectOptions}</select>
        </div>
        <div class="modern-form-group">
            <label class="modern-label">Khối lớp</label>
            <select id="f-khoi" class="modern-select"><option value="">-- Chọn khối --</option>${blockOptions}</select>
        </div>
      `;

      SystemForm(
        'Tạo file mẫu',
        formHtml,
        () => { 
            const namHoc = document.getElementById('f-namhoc').value;
            const subjectId = document.getElementById('f-mon').value;
            const blockId = document.getElementById('f-khoi').value;
            if (!namHoc || !subjectId || !blockId) {
                Swal.showValidationMessage('Vui lòng chọn đầy đủ thông tin!');
                return false;
            }
            return { namHoc, subjectId, blockId };
        },
        'Tải về máy'
      ).then(async result => {
        if (result.isConfirmed) {
            showLoading('Đang tạo file mẫu...');
            
            // Gọi API tạo file mẫu
            const resUrl = await callBackend('generateSampleFile', result.value);
            closeLoading();

            if (resUrl) {
                // Server trả về URL trực tiếp hoặc {url: ...}
                const link = (typeof resUrl === 'string') ? resUrl : resUrl.url;
                if(link) {
                    window.open(link, '_blank');
                    showToast('Đã mở liên kết tải file!', 'success');
                } else {
                    showToast('Không lấy được link tải.', 'error');
                }
            } else {
                showToast('Không tạo được file.', 'error');
            }
        }
      });
    }

    // --- 2. XỬ LÝ UPLOAD FILE ---
    function processFile(input) {
      if (!input.files[0]) return;
      
      document.getElementById('tableBody').innerHTML = `<tr><td colspan="11" class="text-center py-5"><div class="spinner-border text-primary"></div><div class="mt-2 text-muted">Đang đọc file...</div></td></tr>`;
      
      const file = input.files[0];
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        // Chuyển file sang Base64 để gửi qua API JSON
        const base64 = btoa(new Uint8Array(e.target.result).reduce((data, byte) => data + String.fromCharCode(byte), ''));
        
        // Gọi API xử lý upload
        const res = await callBackend('processUpload', { data: base64, mimeType: file.type, name: file.name });
        
        if(res && res.success) {
          RAW_SAVE_DATA = res.saveData;
          renderTable(res.viewData, res.info, res.errorCount);
          if(res.errorCount > 0) showToast(`Có ${res.errorCount} dòng lỗi`, 'warning');
          else showToast('Dữ liệu hợp lệ!', 'success');
        } else {
          showToast(res ? res.msg : "Lỗi xử lý file", 'error');
          renderEmpty();
        }
      };
      
      reader.readAsArrayBuffer(file);
      input.value = '';
    }

    function renderTable(viewData, info, errorCount) {
      const b = document.getElementById('badgeArea');
      b.style.display = 'flex';
      b.innerHTML = `
        <div class="info-tag text-primary"><i class="bi bi-calendar-event"></i> ${info.schoolYear}</div>
        <div class="info-tag text-info"><i class="bi bi-book"></i> ${info.subjectName}</div>
        <div class="info-tag text-success"><i class="bi bi-layers"></i> ${info.blockName}</div>
      `;

      VALID_ROWS = [];
      let html = "";
      
      viewData.forEach((row, i) => {
        const err = row[0];
        if(!err) VALID_ROWS.push(RAW_SAVE_DATA[i]);
        
        const badge = err 
            ? `<span class="status-badge status-error"><i class="bi bi-exclamation-octagon-fill"></i> ${err}</span>` 
            : `<span class="status-badge status-ok"><i class="bi bi-check-circle-fill"></i></span>`;
        const cls = err ? 'class="row-error"' : '';

        html += `<tr ${cls}>
            <td class="text-center">${badge}</td>
            <td>${row[1]}</td>
            <td class="text-center">${row[2]}</td>
            <td>${row[3]}</td>
            <td class="text-center">${row[4]}</td>
            <td class="text-center">${row[5]}</td>
            <td class="text-center">${row[6]}</td>
            <td class="text-center">${row[7]}</td>
            <td>${row[8]}</td>
            <td>${row[9]}</td>
            <td>${row[10]}</td>
        </tr>`;
      });

      document.getElementById('tableBody').innerHTML = html;
      
      const area = document.getElementById('actionArea');
      const btn = document.getElementById('btnSave');
      area.style.display = 'block';
      
      if(VALID_ROWS.length === 0) {
          btn.disabled = true;
          btn.className = "btn btn-secondary btn-sm px-4 py-2";
          btn.textContent = "Không có dữ liệu hợp lệ";
      } else {
          btn.disabled = false;
          if(errorCount > 0) {
              btn.className = "btn btn-warning btn-sm px-4 py-2 fw-bold";
              btn.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>Lưu ${VALID_ROWS.length} dòng (Bỏ lỗi)`;
          } else {
              btn.className = "btn btn-success btn-sm px-4 py-2 fw-bold";
              btn.innerHTML = `<i class="bi bi-cloud-arrow-up-fill me-2"></i>Lưu toàn bộ (${VALID_ROWS.length} dòng)`;
          }
      }
    }

    function renderEmpty() {
      document.getElementById('tableBody').innerHTML = `<tr><td colspan="11" class="p-0 border-0"><div class="empty-state"><i class="bi bi-x-circle"></i><p>Lỗi đọc file</p></div></td></tr>`;
    }

    // --- 3. LƯU DỮ LIỆU ---
    function confirmAndSave() {
      if(VALID_ROWS.length === 0) return;

      SystemConfirm(
        'Lưu dữ liệu?', 
        `Hệ thống sẽ ghi nhận <b>${VALID_ROWS.length}</b> dòng hợp lệ.<br>Dữ liệu cũ cùng điều kiện sẽ bị ghi đè.`,
        'Lưu ngay', 'Xem lại'
      ).then(async r => {
        if(r.isConfirmed) {
            showLoading('Đang lưu vào hệ thống...');
            
            // Gọi API lưu
            const res = await callBackend('saveToPlan', { data: VALID_ROWS });
            
            closeLoading();
            if(res && res.success) {
                showToast(`Đã lưu thành công ${VALID_ROWS.length} dòng!`, 'success');
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="11" class="p-0 border-0"><div class="empty-state text-success"><i class="bi bi-check-circle-fill text-success"></i><p>Hoàn tất!</p></div></td></tr>`;
                document.getElementById('actionArea').style.display = 'none';
                document.getElementById('badgeArea').style.display = 'none';
            } else {
                showToast(res ? res.msg : "Lỗi lưu dữ liệu", 'error');
            }
        }
      });
    }
  </script>
</body>
</html>