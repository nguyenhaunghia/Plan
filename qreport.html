<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T·ªïng h·ª£p Ti·∫øn ƒë·ªô</title>
  
  <link rel="stylesheet" href="style.css">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <style>
    /* ==========================================================================
       GI·ªÆ NGUY√äN CSS G·ªêC C·ª¶A B·∫†N (QUY T·∫ÆC B·∫¢O TO√ÄN)
       ========================================================================== */
    body { font-family: 'Inter', sans-serif; background-color: #f4f7fa; }
    .header-box { background: #2c3e50; color: white; padding: 20px; border-radius: 0 0 15px 15px; }
    .btn-home { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; }
    .btn-home:hover { background: white; color: #2c3e50; }

    /* Navbar Customization */
    .navbar-custom { background: #1e293b; color: white; padding: 0.8rem 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }

    .accordion-item { border: 1px solid #dee2e6; margin-bottom: 8px; border-radius: 10px !important; overflow: hidden; }
    .btn-year { background: #3498db !important; color: white !important; font-weight: 700; }
    .btn-teacher { background: #ffffff !important; color: #2c3e50 !important; font-weight: 600; border-bottom: 1px solid #eee !important; }
    .btn-subject { background: #fdfdfd !important; color: #2980b9 !important; font-size: 0.95rem; font-weight: 600; }
    
    .class-card { background: white; border: 1px solid #eaedf0; border-radius: 8px; padding: 12px; margin-bottom: 10px; }
    .class-header { font-weight: 700; color: #2c3e50; border-bottom: 1px solid #f1f1f1; margin-bottom: 8px; padding-bottom: 4px; }
    
    /* Style cho Program Number */
    .prog-normal { color: #7f8c8d; font-weight: 400; }
    .prog-duplicate { color: #c0392b; font-weight: 900; text-decoration: underline; }

    .week-row { display: flex; align-items: center; margin-bottom: 5px; }
    .week-label { width: 140px; font-size: 0.75rem; font-weight: 600; color: #7f8c8d; }
    .week-badge { 
      padding: 2px 8px; margin: 2px; border-radius: 4px; font-size: 0.8rem; 
      background: #f8f9fa; color: #495057; border: 1px solid #dee2e6;
    }
    .week-max { background: #e74c3c !important; color: white !important; font-weight: 800; border: none; }
    
    #loader { padding: 100px 0; text-align: center; }
  </style>
</head>
<body>
  <header>
    <nav class="navbar-custom">
      <div class="d-flex align-items-center">
        <button class="btn btn-outline-light btn-sm me-3" onclick="goHome()" title="Trang ch·ªß"><i class="bi bi-house"></i></button>
        <h5 class="m-0 fw-bold">T·ªîNG H·ª¢P TI·∫æN ƒê·ªò TH·ª∞C HI·ªÜN CH∆Ø∆†NG TR√åNH </h5>
      </div>  
    </nav>
  </header>

<div class="container mt-4 pb-5">
  <div id="loader">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3 text-secondary">ƒêang t·ªïng h·ª£p d·ªØ li·ªáu b√†i d·∫°y...</p>
  </div>
  <div id="mainAccordion" class="accordion"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="script.js"></script>

<script>


  window.onload = loadData;

  async function loadData() {
    // G·ªçi API l·∫•y th·ªëng k√™ B√°o gi·∫£ng
    // L∆∞u √Ω: Code.gs c·∫ßn case 'getQReportStatistics'
    const data = await callBackend('getQReportStatistics', {});
    
    // H√†m c≈© tr·∫£ v·ªÅ m·∫£ng tr·ª±c ti·∫øp [], API m·ªõi c√≥ th·ªÉ tr·∫£ v·ªÅ object {success: true, data: []}
    let resultData = [];
    if (Array.isArray(data)) {
        resultData = data;
    } else if (data && data.success && Array.isArray(data.data)) {
        resultData = data.data; 
    } else if (data) {
        resultData = data; // Fallback
    }

    drawUI(resultData);
  }

  function drawUI(data) {
    document.getElementById('loader').style.display = 'none';
    const container = document.getElementById('mainAccordion');

    if (!data || data.length === 0) {
        container.innerHTML = '<div class="alert alert-warning text-center">Kh√¥ng c√≥ d·ªØ li·ªáu b√°o gi·∫£ng.</div>';
        return;
    }

    data.forEach((y, yIdx) => {
      const yId = `year_${yIdx}`;
      let teacherHtml = '';

      y.teachers.forEach((t, tIdx) => {
        const tId = `tea_${yIdx}_${tIdx}`;
        let subjectHtml = '';

        t.subjects.forEach((s, sIdx) => {
          const sId = `sub_${yIdx}_${tIdx}_${sIdx}`;
          let classHtml = '';

          s.classes.forEach(cls => {
            // X·ª≠ l√Ω hi·ªÉn th·ªã Program Numbers: In ƒë·∫≠m v√† g·∫°ch ch√¢n n·∫øu tr√πng (isDup)
            const formattedProgs = cls.progList.map((p, index) => {
              const separator = index < cls.progList.length - 1 ? ", " : "";
              return p.isDup 
                ? `<span class="prog-duplicate">${p.val}</span>${separator}` 
                : `<span class="prog-normal">${p.val}</span>${separator}`;
            }).join('');

            classHtml += `
              <div class="class-card shadow-sm">
                <div class="class-header">
                  üè´ L·ªõp: ${cls.name}: ${formattedProgs}
                </div>
                
                <div class="week-row">
                  <div class="week-label">üìÖ Tu·∫ßn chuy√™n m√¥n:</div>
                  <div class="d-flex flex-wrap">
                    ${cls.planWeeks.map(w => `<span class="week-badge ${w === cls.maxPlan ? 'week-max' : ''}">${w}</span>`).join('')}
                  </div>
                </div>

                <div class="week-row">
                  <div class="week-label">üóìÔ∏è Tu·∫ßn c√¥ng t√°c:</div>
                  <div class="d-flex flex-wrap">
                    ${cls.schoolWeeks.map(w => `<span class="week-badge ${w === cls.maxSchool ? 'week-max' : ''}">${w}</span>`).join('')}
                  </div>
                </div>
              </div>`;
          });

          subjectHtml += `
            <div class="accordion-item border-0">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed btn-subject" data-bs-toggle="collapse" data-bs-target="#${sId}">
                  üìò M√¥n: ${s.name}
                </button>
              </h2>
              <div id="${sId}" class="accordion-collapse collapse">
                <div class="accordion-body bg-white p-2">
                  ${classHtml}
                </div>
              </div>
            </div>`;
        });

        teacherHtml += `
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed btn-teacher" data-bs-toggle="collapse" data-bs-target="#${tId}">
                üë®‚Äçüè´ Gi√°o vi√™n: ${t.name}
              </button>
            </h2>
            <div id="${tId}" class="accordion-collapse collapse">
              <div class="accordion-body bg-light p-2">
                <div class="accordion shadow-sm">${subjectHtml}</div>
              </div>
            </div>
          </div>`;
      });

      container.innerHTML += `
        <div class="accordion-item shadow mb-3">
          <h2 class="accordion-header">
            <button class="accordion-button btn-year" data-bs-toggle="collapse" data-bs-target="#${yId}">
              üìÖ NƒÉm h·ªçc: ${y.year}
            </button>
          </h2>
          <div id="${yId}" class="accordion-collapse collapse ${yIdx === 0 ? 'show' : ''}">
            <div class="accordion-body p-2">
              <div class="accordion">${teacherHtml}</div>
            </div>
          </div>
        </div>`;
    });
  }

  function goHome() { window.location.href = "wellcome.html"; }
</script>
</body>
</html>