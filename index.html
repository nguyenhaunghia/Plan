<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SMART SCHOOL - Đăng nhập</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@800&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="style.css">
  
  <style>
    /* CSS cục bộ cho trang login */
    input[type="text"], input[type="password"], input[type="number"] { font-size: 16px !important; }
    
    /* Đảm bảo modal luôn ẩn ban đầu */
    #changePassModal { display: none; }
    
    /* Căn giữa modal khi hiện */
    .qr-modal.show-flex {
        display: flex !important;
        align-items: center;
        justify-content: center;
    }
  </style>
</head>

<body class="body-login">
<div class="loader-line" id="globalLoader" style="display:none"></div>

<div class="login-container">
  <div class="login-card">
    <div class="logo-icon" style="text-align: center; margin-bottom: 15px;">
        <i class="bi bi-mortarboard-fill" style="font-size: 4rem; color: #0d47a1; filter: drop-shadow(0 4px 6px rgba(13, 71, 161, 0.2));"></i>
    </div>
    
    <h3 class="fw-bold text-dark mb-1">KẾ HOẠCH THỰC HIỆN CHƯƠNG TRÌNH</h3>
    <p class="text-muted mb-4 small">Ver 2.5.2026 - Standalone</p>
    
    <form id="loginForm" onsubmit="handleLoginSubmit(event)">
        <div class="form-floating mb-3 input-group">
          <input type="text" class="form-control" id="username" list="accountList" 
                 autocomplete="username" placeholder="Account" required>
          <label><i class="bi bi-person me-2"></i>Tài khoản</label>
          <datalist id="accountList"></datalist>
        </div>
        
        <div class="form-floating mb-3 input-group">
          <input type="password" class="form-control" id="password" 
                 autocomplete="current-password" placeholder="Password" required>
          <label><i class="bi bi-lock me-2"></i>Mật khẩu</label>
          <i class="fas fa-eye toggle-pass" onclick="toggleView('password', this)"></i>
        </div>
        
        <button type="submit" class="btn btn-primary w-100 btn-login text-white" id="btnLogin">
          <div id="loader" class="spinner" style="display:none"></div>
          <span id="txtLogin">ĐĂNG NHẬP</span>
        </button>
    </form>
  </div>
</div>

<div id="changePassModal" class="qr-modal">
  <div class="modal-content" style="width: 90%; max-width: 500px; padding: 30px; border-radius: 20px; margin: auto;">
    <h3 style="margin-top:0; color: var(--primary-dark); font-weight:700;">
        <i class="fas fa-shield-alt" style="color: var(--primary-color);"></i> Cài đặt mật khẩu
    </h3>
    <div class="pass-hint">
      <b>Yêu cầu:</b> Mật khẩu mới để bảo vệ tài khoản của bạn.
    </div>
    
    <form id="changePassForm" onsubmit="handleChangePassSubmit(event)">
        <div class="form-floating mb-3 input-group">
          <input type="password" class="form-control" id="newPass" placeholder="Mật khẩu mới" 
                 autocomplete="new-password" oninput="validateMatch()" required>
          <label><i class="fas fa-key me-2"></i>Mật khẩu mới</label>
          <i class="fas fa-eye toggle-pass" onclick="toggleView('newPass', this)"></i>
        </div>
        
        <div class="form-floating mb-3 input-group">
          <input type="password" class="form-control" id="confirmPass" placeholder="Xác nhận mật khẩu" 
                 autocomplete="new-password" oninput="validateMatch()" required>
          <label><i class="fas fa-check-double me-2"></i>Xác nhận mật khẩu</label>
          <i id="iconCheck" class="fas fa-check-circle check-icon"></i>
          <i class="fas fa-eye toggle-pass" onclick="toggleView('confirmPass', this)"></i>
        </div>
        
        <button type="submit" class="btn btn-success w-100" id="btnUpdate">
          <div id="modalLoader" class="spinner" style="display:none"></div>
          <span id="txtUpdate">Cập nhật & Đăng nhập</span>
        </button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="script.js"></script>

<script>
  // --- CẤU HÌNH KẾT NỐI ---
  const API_URL = "https://script.google.com/macros/s/AKfycbznKOzD1DnZtyWq1Pd-WfsXhrWuH2mgJ5XOjvHCmo5w_51OeJ0xHkSy3bvpdRtNmZlP/exec"; // <-- DÁN LINK WEB APP CỦA BẠN VÀO ĐÂY
  
  const $ = id => document.getElementById(id);
  let currentLoggingUser = ""; // Biến lưu tạm user để đổi pass

  // --- HÀM GỌI API ---
  async function callBackend(action, data) {
    const url = `${API_URL}?action=${action}&data=${encodeURIComponent(JSON.stringify(data))}`;
    try {
      const response = await fetch(url);
      return await response.json();
    } catch (e) {
      console.error(e);
      return { success: false, message: "Lỗi kết nối Server!" };
    }
  }

  // --- XỬ LÝ SỰ KIỆN ---
  function handleLoginSubmit(e) { e.preventDefault(); document.activeElement.blur(); processLogin(); }
  function handleChangePassSubmit(e) { e.preventDefault(); document.activeElement.blur(); changePassword(); }

  // --- GIAO DIỆN ---
  function toggleView(id, el) {
    const inp = $(id); const isP = inp.type === "password";
    inp.type = isP ? "text" : "password";
    el.classList.toggle('fa-eye', !isP); el.classList.toggle('fa-eye-slash', isP);
  }

  function validateMatch() {
    const ic = $('iconCheck');
    if ($('newPass').value && $('newPass').value === $('confirmPass').value) ic.classList.add('check-active');
    else ic.classList.remove('check-active');
  }

  function setProcessing(type, isLoad) {
    if (type === 'login') {
      $('btnLogin').disabled = isLoad;
      $('loader').style.display = isLoad ? "block" : "none";
      $('txtLogin').style.display = isLoad ? "none" : "inline";
      $('globalLoader').style.display = isLoad ? 'block' : 'none';
    } else {
      $('btnUpdate').disabled = isLoad;
      $('modalLoader').style.display = isLoad ? "block" : "none";
      $('txtUpdate').style.display = isLoad ? "none" : "inline";
    }
  }

  // --- LOGIC CHÍNH ---
  async function processLogin() {
    const u = $('username').value.trim();
    const p = $('password').value.trim();
    if(!u || !p) return showToast('Vui lòng nhập đủ thông tin', 'warning');

    setProcessing('login', true);
    const res = await callBackend('checkLogin', {u, p});
    setProcessing('login', false);

    if(res.success) {
      if (res.requireNewPass) {
        // ==> TRƯỜNG HỢP 1: PHẢI ĐỔI MẬT KHẨU
        currentLoggingUser = u; 
        
        // Hiện modal bằng cách thêm class flex
        $('changePassModal').classList.add('show-flex');
        
        showToast('Mật khẩu mặc định. Vui lòng đổi mới!', 'info');
      } else {
        // ==> TRƯỜNG HỢP 2: ĐĂNG NHẬP THÀNH CÔNG LUÔN
        localStorage.setItem('userData', JSON.stringify(res.user));
        showToast('Đăng nhập thành công', 'success');
        setTimeout(() => { window.location.href = "wellcome.html"; }, 500);
      }
    } else {
      showToast(res.message || "Đăng nhập thất bại", 'error');
    }
  }

  async function changePassword() {
    const newP = $('newPass').value;
    const confP = $('confirmPass').value;
    // Validate cơ bản
    if (newP.length < 8) return showToast('Mật khẩu phải từ 8 ký tự trở lên', 'warning');
    if (newP !== confP) return showToast('Mật khẩu xác nhận không khớp', 'error');

    setProcessing('change', true);
    
    // Gọi API update password
    const res = await callBackend('updateFirstPassword', {u: currentLoggingUser, newP: newP});
    
    if (res.success) {
      showToast('Cập nhật thành công!', 'success');
      localStorage.setItem('userData', JSON.stringify(res.user));
      setTimeout(() => { window.location.href = "welcome.html"; }, 500);
    } else {
      setProcessing('change', false);
      showToast(res.message || "Lỗi cập nhật", 'error');
    }
  }
</script>

</body>
</html>
