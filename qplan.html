<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Tra cứu Kế hoạch</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  
  <link rel="stylesheet" href="style.css">

  <style>
    /* ==========================================================================
       GIỮ NGUYÊN CSS GỐC CỦA BẠN (QUY TẮC BẢO TOÀN)
       ========================================================================== */
    body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; color: #1c1e21; -webkit-font-smoothing: antialiased; }
    
    /* Navbar Customization */
    .navbar-custom { background: #1e293b; color: white; padding: 0.8rem 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
    
    /* Icon Refresh Styling */
    .refresh-icon {
        cursor: pointer;
        transition: transform 0.4s ease, opacity 0.2s;
        font-size: 1.3rem;
        vertical-align: middle;
    }
    .refresh-icon:hover {
        transform: rotate(180deg);
        opacity: 0.8;
    }
    .refresh-icon:active {
        transform: rotate(360deg);
    }

    .stat-card { border: none; border-radius: 12px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; overflow: hidden; }
    .accordion-button { font-weight: 700; color: #1a73e8 !important; background-color: #ffffff !important; padding: 1rem 1.25rem; }
    .accordion-button:not(.collapsed) { background-color: #f8fbff !important; box-shadow: none; border-bottom: 1px solid #e8f0fe; }
    .accordion-button:focus { box-shadow: none; border-color: rgba(0,0,0,.125); }
    
    .subject-item { border-left: 5px solid #34a853; margin: 10px 0; background: #fff; border-radius: 8px; overflow: hidden; }
    .block-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; cursor: pointer; user-select: none; }
    .block-list-item:active { background-color: #eef3f8; }
    
    .badge-count { background: #34a853; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; white-space: nowrap; }
    
    #loading { display: flex; flex-direction: column; align-items: center; margin-top: 80px; text-align: center; }

    /* --- Desktop Table Styles --- */
    .table-lesson th { background-color: #f8fafc; font-size: 0.85rem; text-transform: uppercase; color: #64748b; font-weight: 600; vertical-align: middle; white-space: nowrap; }
    .table-lesson td { vertical-align: middle; font-size: 0.95rem; padding: 0.75rem 0.5rem; }
    .col-week { width: 60px; text-align: center; font-weight: bold; color: #1a73e8; }
    .col-prog { width: 60px; text-align: center; font-weight: bold; }
    .col-tool { width: 250px; }
    .col-loc  { width: 250px; }

    /* --- RESPONSIVE DESIGN (MOBILE OPTIMIZATION) --- */
    @media (max-width: 768px) {
        .container { padding: 0 10px; max-width: 100%; }
        .navbar-custom h5 { font-size: 1.1rem; }
        
        .accordion-button { padding: 0.75rem 1rem; font-size: 0.95rem; }
        .subject-item { margin: 8px 0; }
        .accordion-body { padding: 10px !important; }

        /* Card View for Mobile */
        .table-lesson thead { display: none; }
        
        .table-lesson, .table-lesson tbody, .table-lesson tr, .table-lesson td { display: block; width: 100%; }

        .table-lesson tr {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 12px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .table-lesson td { padding: 2px 0; border: none; text-align: left; }

        .col-week, .col-prog {
            display: inline-block !important; width: auto !important;
            font-size: 0.85rem; color: #5f6368; background: #f1f3f4;
            padding: 2px 8px !important; border-radius: 4px;
            margin-bottom: 5px; margin-right: 5px;
        }
        
        .col-week::before { content: "Tuần: "; font-weight: normal; color: #5f6368; }
        .col-prog::before { content: "Tiết: "; font-weight: normal; color: #5f6368; }

        .table-lesson td:nth-child(3) { /* Tên bài học */
            font-size: 1rem; font-weight: 600; color: #1a73e8;
            margin-bottom: 8px; line-height: 1.4; display: block;
            padding-top: 5px !important;
        }

        .col-tool, .col-loc {
            font-size: 0.85rem; color: #444; display: flex !important;
            align-items: center; width: 100% !important; padding: 2px 0 !important;
        }
        
        .col-loc i, .col-tool i { font-size: 0.9rem; width: 20px; text-align: center; margin-right: 5px; }
        
        .table-lesson tr td[colspan="5"] { text-align: center; color: #999; font-style: italic; padding: 20px; }
    }
  </style>
</head>
<body>

  <header>
    <nav class="navbar-custom">
      <div class="d-flex align-items-center w-100">
         <button class="btn btn-outline-light btn-sm me-3 border-0 bg-transparent p-0" onclick="goHome()" title="Trang chủ">
            <i class="bi bi-house-door-fill fs-5"></i>
         </button>
         
         <h5 class="m-0 fw-bold text-truncate">TỔNG HỢP</h5>
         
         <i class="bi bi-arrow-clockwise ms-2 refresh-icon" onclick="loadData()" title="Tải lại dữ liệu"></i>
      </div>  
    </nav>
  </header>
  <br>
  
  <div class="container" style="max-width: 1200px;">
    <div id="loading">
      <div class="spinner-border text-primary" style="width: 2.5rem; height: 2.5rem;" role="status"></div>
      <span class="mt-3 fw-semibold text-secondary small">Đang tải dữ liệu...</span>
    </div>

    <div id="main-container" class="accordion shadow-sm mb-5"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="script.js"></script>

  <script>

    let LOCATION_MAP = {}; 


    window.onload = function() {
        loadLocationCatalog(); 
        loadData();            
    };

    function goHome() { window.location.href = "wellcome.html"; }

    async function loadLocationCatalog() {
        // Lấy danh mục địa điểm (Nếu có API riêng thì gọi, không thì gọi getData để lấy suggestion)
        // Trong Code.gs, ta có thể dùng getData hoặc viết thêm case lấy Catalog.
        // Ở đây giả định dùng getData để lấy suggestions
        const res = await callBackend('getData', {});
        if(res && res.success && res.suggestions && res.suggestions.locations) {
            LOCATION_MAP = res.suggestions.locations;
        } else {
            console.log("Không tải được danh mục địa điểm");
        }
    }

    async function loadData() {
      document.getElementById('loading').style.display = 'flex';
      document.getElementById('main-container').innerHTML = '';
      
      // Gọi API lấy thống kê Kế hoạch
      // Lưu ý: Code.gs cần case 'getQPlanStatistics'
      const data = await callBackend('getQPlanStatistics', {});
      
      // Hàm cũ trả về mảng trực tiếp [], API mới có thể trả về object {success: true, data: []}
      // Cần kiểm tra kỹ
      let resultData = [];
      if (Array.isArray(data)) {
          resultData = data;
      } else if (data && data.success && Array.isArray(data.data)) {
          resultData = data.data; 
      } else if (data) {
          resultData = data; // Fallback
      }

      drawUI(resultData);
    }

    function drawUI(data) {
      document.getElementById('loading').style.display = 'none';
      const container = document.getElementById('main-container');
      container.innerHTML = ''; 
      
      if (!data || data.length === 0) {
          container.innerHTML = '<div class="alert alert-warning text-center">Không có dữ liệu kế hoạch.</div>';
          return;
      }

      data.forEach((item, index) => {
        const yearId = `year_${index}`;
        let subjectHtml = '';

        item.subjects.forEach((sub, subIdx) => {
          const subId = `sub_${index}_${subIdx}`;
          let blockHtml = '';

          sub.blocks.forEach((blk, blkIdx) => {
            const lessonId = `lessons_${index}_${subIdx}_${blkIdx}`;
            
            let lessonRows = '';
            if (blk.lessons && blk.lessons.length > 0) {
              blk.lessons.forEach(lsn => {
                const locId = lsn.locationGroupId || '';
                const locName = LOCATION_MAP[locId] || locId; 
                const toolName = lsn.toolsId || '';

                lessonRows += `
                  <tr>
                    <td class="col-week">${lsn.week}</td>
                    <td class="col-prog">${lsn.progNumber}</td>
                    <td>${lsn.name}</td>
                    <td class="col-tool text-muted small">
                        ${toolName ? `<i class="bi bi-tools text-secondary"></i>${toolName}` : ''}
                    </td>
                    <td class="col-loc text-muted small">
                        ${locName ? `<i class="bi bi-geo-alt-fill text-danger"></i>${locName}` : ''}
                    </td>
                  </tr>`;
              });
            } else {
              lessonRows = '<tr><td colspan="5" class="text-center text-muted py-3">Chưa có dữ liệu bài học</td></tr>';
            }

            blockHtml += `
              <div class="block-wrapper border-bottom">
                <div class="block-list-item" data-bs-toggle="collapse" data-bs-target="#${lessonId}">
                  <span class="text-dark"><i class="bi bi-building me-2 text-secondary"></i>Khối: <strong>${blk.name}</strong></span>
                  <div class="d-flex align-items-center">
                    <span class="badge-count me-2">${blk.count} bài</span>
                    <i class="bi bi-chevron-down small text-muted"></i>
                  </div>
                </div>
                
                <div id="${lessonId}" class="collapse lesson-detail-container">
                  <div class="table-responsive bg-white">
                    <table class="table table-sm table-lesson table-hover mb-0 align-middle">
                      <thead>
                        <tr>
                          <th class="text-center">Tuần</th>
                          <th class="text-center">Tiết</th>
                          <th>Tên bài học</th>
                          <th>Thiết bị</th>
                          <th>Địa điểm</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${lessonRows}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>`;
          });

          subjectHtml += `
            <div class="subject-item shadow-sm">
              <div class="p-3 d-flex justify-content-between align-items-center bg-white" 
                   style="cursor:pointer;" 
                   data-bs-toggle="collapse" 
                   data-bs-target="#${subId}">
                <span class="fw-bold text-secondary text-truncate" style="max-width: 70%;"><i class="bi bi-book-half me-2 text-primary"></i>${sub.name}</span>
                <small class="text-primary fw-bold text-nowrap">Chi tiết <i class="bi bi-caret-down-fill"></i></small>
              </div>
              <div id="${subId}" class="collapse bg-light border-top">
                ${blockHtml}
              </div>
            </div>`;
        });

        container.innerHTML += `
          <div class="accordion-item stat-card">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed px-3 py-3" type="button" data-bs-toggle="collapse" data-bs-target="#${yearId}">
                <i class="bi bi-calendar-check me-2 fs-5"></i> Năm học: ${item.year}
              </button>
            </h2>
            <div id="${yearId}" class="accordion-collapse collapse" data-bs-parent="#main-container">
              <div class="accordion-body bg-light px-2 py-2">
                ${subjectHtml}
              </div>
            </div>
          </div>`;
      });
    }
  </script>
</body>
</html>